<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Task Manager - Zugo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', path='report.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', path='task_manager.css') }}">
</head>
<body>
  <div class="container">
    <!-- *** FIXED SIDEBAR: Correct links and 'active' class *** -->
    <div class="sidebar">
        <div class="logo">
            <img src="{{ url_for('static', path='zugo logo.png') }}" alt="Zugo Logo" style="max-width:120px; height:auto; margin-bottom:16px;">
        </div>
        <ul>
            <li><a href="{{ url_for('dashboard_view') }}">Home page</a></li>
            <li><a href="{{ url_for('dashboard_view') }}">Overview</a></li>
            <li><a href="{{ url_for('employees_page') }}">Employee's</a></li>
            <li><a href="{{ url_for('report') }}">Attendance</a></li>
            <li class="active"><a href="{{ url_for('workspace') }}">Tasks</a></li>
            {% if is_hr %}
            <li><a href="{{ url_for('hr_management') }}" style="color: #e74c3c; font-weight: bold;">‚öôÔ∏è Management</a></li>
            {% endif %}
        </ul>
        <div class="help-center">
            <p>Help Centre</p><br>
            <p>Terms & Conditions</p><br>
            <p>Privacy & Policy</p>
        </div>
    </div>

    <div class="main-content">
      <header>
        <a href="{{ url_for('dashboard_view') }}" style="color: #fff; text-decoration: none; font-weight: bold;">
          ‚¨Ö Overview
        </a>
        <div style="display: flex; align-items: center; gap: 20px;">
          <div class="search">
            <input id="search" placeholder="Search tasks..." />
          </div>
          
          <div id="notif" style="position:relative; display:inline-block; cursor:pointer;">
            <span id="notifBell">üîî</span>
            <div id="notifDropdown" style="display:none;">
              <div class="notif-header">Notifications</div>
              <div class="notif-content">
                <div class="notif-item">No new notifications</div>
              </div>
            </div>
          </div>

          {% if is_hr %}
          <button onclick="openAssignModal()" class="btn btn-primary">Assign Task</button>
          {% endif %}
        </div>
      </header>

      <!-- Hidden server data to be read by JavaScript -->
      <script type="application/json" id="server-tasks">
        {{ assigned_tasks | tojson }}
      </script>

      <div id="board-wrap">
        <div id="board" aria-label="Lists container"></div>
      </div>

      <div id="bottom-bar">
        <button id="add-list" title="Add list">+ Add List</button>
      </div>
      
      <div id="modal" class="hidden" role="dialog">
        <div class="modal-content">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Edit Task</h3>
            <button id="close-modal" class="icon-btn" title="Close">‚úñ</button>
          </div>
          <input id="card-title" placeholder="Title" />
          <textarea id="card-desc" rows="3" placeholder="Description"></textarea>
          <input type="date" id="card-date" />
          <div class="modal-actions">
            <button id="delete-card" class="btn btn-danger">Delete</button>
            <button id="save-card" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>

      <!-- *** FIXED: 'hidden' class added so it's not visible on load *** -->
      <div id="assign-modal" class="modal hidden" role="dialog">
        <div class="modal-content">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Assign New Task</h3>
            <button onclick="closeAssignModal()" class="icon-btn" title="Close">‚úñ</button>
          </div>
          <form action="{{ url_for('assign_task') }}" method="POST">
            <input type="text" name="title" placeholder="Task Title" required />
            <textarea name="description" rows="3" placeholder="Task Description" required></textarea>
            
            <div style="margin-bottom: 10px;">
              <label style="font-size: 13px; color: #374151; display: block; margin-bottom: 5px;">Select Employees for Task</label>
              <select id="employee-select" style="padding: 8px; box-sizing: border-box; width: 100%; border-radius: 8px; border: 1px solid #e5e7eb;">
                <option value="">-- Select an Employee --</option>
                {% for emp in employees %}
                  <option value="{{ emp.email }}" data-name="{{ emp.name }}">{{ emp.name }} ({{ emp.email }})</option>
                {% endfor %}
              </select>
            </div>

            <!-- Button to add selected employee -->
            <button type="button" id="add-employee-btn" class="btn" style="width: 100%; padding: 8px; margin-bottom: 10px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer;">+ Add Employee to Task</button>

            <!-- Display selected employees -->
            <div id="selected-employees" style="min-height: 60px; background: #f9f9f9; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
              <div style="font-size: 12px; color: #666; font-weight: bold; margin-bottom: 5px;">Assigned Employees:</div>
              <div id="employees-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                <span style="color: #999; font-size: 12px;">None selected</span>
              </div>
            </div>

            <!-- Hidden input to store selected employees (comma-separated) -->
            <input type="hidden" id="assigned_employees" name="assigned_to" value="" required />

            <input type="date" name="due_date" required />
            <div class="modal-actions">
              <button type="button" onclick="closeAssignModal()" class="btn">Cancel</button>
              <button type="submit" class="btn btn-primary">Assign Task</button>
            </div>
          </form>
        </div>
      </div>

<script>
// =================================================================================
// --- CORRECTED AND SIMPLIFIED JAVASCRIPT ---
// =================================================================================
const STORAGE_KEY = "task_manager_data";
let state = {};

// --- STATE MANAGEMENT ---
function initializeState() {
  const localData = loadState();
  const serverTasksData = document.getElementById('server-tasks');
  let serverTasks = [];

  try {
    serverTasks = JSON.parse(serverTasksData.textContent || '[]');
  } catch (e) {
    console.error("Could not parse server tasks.", e);
    serverTasks = [];
  }

  if (localData) {
    state = localData;
    // Merge server tasks into the 'To Do' list of the local data
    const todoList = state.lists.find(l => l.title === "To Do");
    if (todoList && serverTasks.length > 0) {
      serverTasks.forEach(task => {
        // Avoid adding duplicates
        if (!todoList.cards.some(card => card.taskId === task.id)) {
          todoList.cards.push(serverTaskToCard(task));
        }
      });
    }
  } else {
    // If no local data, build the entire board from scratch
    state = defaultState();
    const todoList = state.lists[0]; // 'To Do' is the first list
    serverTasks.forEach(task => todoList.cards.push(serverTaskToCard(task)));
  }
  saveState();
}

function serverTaskToCard(task) {
  return {
    id: 'server-task-' + task.id,
    title: task.title,
    desc: task.description || "",
    date: task.due_date || "",
    taskId: task.id // Keep track of the original DB ID
  };
}

function defaultState() {
  return {
    lists: [
      { id: id(), title: "To Do", cards: [] },
      { id: id(), title: "In Progress", cards: [] },
      { id: id(), title: "Completed", cards: [] },
    ]
  };
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadState() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY));
  } catch (e) {
    return null;
  }
}

function id() {
  return "id-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2);
}

// --- DOM ELEMENTS ---
const board = document.getElementById("board");
const addListBtn = document.getElementById("add-list");
const modal = document.getElementById("modal");
const closeModalBtn = document.getElementById("close-modal");
const saveCardBtn = document.getElementById("save-card");
const deleteCardBtn = document.getElementById("delete-card");

let current = { listId: null, cardId: null };
let isDraggingCard = false;

// --- RENDERING ---
function renderBoard() {
  board.innerHTML = "";
  if (!state.lists) state.lists = [];

  state.lists.forEach(list => {
    const listEl = document.createElement("div");
    listEl.className = "list";
    listEl.dataset.listId = list.id;

    // Header with title and delete button
    const header = document.createElement("div");
    header.className = "list-header";
    const titleEl = document.createElement("div");
    titleEl.className = "list-title";
    titleEl.textContent = list.title;
    const deleteListBtn = document.createElement("button");
    deleteListBtn.innerHTML = "üóë";
    deleteListBtn.className = "icon-btn";
    deleteListBtn.onclick = () => {
        if (confirm(`Are you sure you want to delete the "${list.title}" list?`)) {
            state.lists = state.lists.filter(l => l.id !== list.id);
            saveState();
            renderBoard();
        }
    };
    header.appendChild(titleEl);
    header.appendChild(deleteListBtn);
    listEl.appendChild(header);

    // Cards container
    const cardsWrap = document.createElement("div");
    cardsWrap.className = "cards";
    cardsWrap.dataset.listId = list.id;
    list.cards.forEach(card => {
        const cardEl = document.createElement("div");
        cardEl.className = "card";
        cardEl.draggable = true;
        cardEl.dataset.cardId = card.id;
        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = card.title;
        cardEl.appendChild(title);
        cardEl.onclick = () => openModal(list.id, card.id);
        cardsWrap.appendChild(cardEl);
    });
    listEl.appendChild(cardsWrap);

    // Add card button
    const addCardBtn = document.createElement("button");
    addCardBtn.className = "add-card";
    addCardBtn.textContent = "+ Add Task";
    addCardBtn.onclick = () => {
        const title = prompt("Enter task title:");
        if (title) {
            list.cards.push({ id: id(), title });
            saveState();
            renderBoard();
        }
    };
    listEl.appendChild(addCardBtn);
    board.appendChild(listEl);
  });
}

// --- MODAL & EVENT HANDLERS ---
function openModal(listId, cardId) {
  current = { listId, cardId };
  const card = state.lists.find(l => l.id === listId)?.cards.find(c => c.id === cardId);
  if (!card) return;
  document.getElementById("card-title").value = card.title;
  document.getElementById("card-desc").value = card.desc || "";
  document.getElementById("card-date").value = card.date || "";
  modal.classList.remove("hidden");
}

function closeModal() {
  modal.classList.add("hidden");
}

function openAssignModal() {
  document.getElementById("assign-modal").classList.remove("hidden");
}

function closeAssignModal() {
  document.getElementById("assign-modal").classList.add("hidden");
}

// *** CRITICAL FIX: The event listener for 'archive-card' is removed ***
// It was causing the script to crash.

addListBtn.addEventListener("click", () => {
  const name = prompt("Enter new list name:");
  if (name) {
    state.lists.push({ id: id(), title: name, cards: [] });
    saveState();
    renderBoard();
  }
});

closeModalBtn.addEventListener("click", closeModal);

saveCardBtn.addEventListener("click", () => {
  const card = state.lists.find(l => l.id === current.listId)?.cards.find(c => c.id === current.cardId);
  if (card) {
    card.title = document.getElementById("card-title").value.trim();
    card.desc = document.getElementById("card-desc").value.trim();
    card.date = document.getElementById("card-date").value;
    saveState();
    renderBoard();
  }
  closeModal();
});

deleteCardBtn.addEventListener("click", () => {
  if (confirm("Are you sure you want to delete this task?")) {
    const list = state.lists.find(l => l.id === current.listId);
    if (list) {
      list.cards = list.cards.filter(c => c.id !== current.cardId);
      saveState();
      renderBoard();
    }
  }
  closeModal();
});

// --- INITIALIZATION ---
document.addEventListener("DOMContentLoaded", () => {
  initializeState();
  renderBoard();
});
</script>
    </div>
  </div>
</body>
</html>