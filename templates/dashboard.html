<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Profile</title>
  <link rel="shortcut icon" href="{{ url_for('static', path='favicon.ico') }}" type="image/x-icon">
  <!-- Link external CSS -->
  <link rel="stylesheet" href="{{ url_for('static', path='dashboard.css') }}">
  
  <script>
    // Function to get current location
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    function showPosition(position) {
        // Set the hidden fields for both check-in and check-out forms
        document.getElementById("latitude_checkin").value = position.coords.latitude;
        document.getElementById("longitude_checkin").value = position.coords.longitude;
        document.getElementById("latitude_checkout").value = position.coords.latitude;
        document.getElementById("longitude_checkout").value = position.coords.longitude;
    }

    function showError(error) {
        switch(error.code) {
            case error.PERMISSION_DENIED:
                alert("User denied the request for Geolocation. Cannot track attendance.");
                break;
            case error.POSITION_UNAVAILABLE:
                alert("Location information is unavailable.");
                break;
            case error.TIMEOUT:
                alert("The request to get user location timed out.");
                break;
            case error.UNKNOWN_ERROR:
                alert("An unknown error occurred.");
                break;
        }
    }

    // Call getLocation when the dashboard loads
    window.onload = getLocation;

    function setLocationAndSubmit(form) {
      const lat = form.querySelector('[name="latitude"]').value;
      const lon = form.querySelector('[name="longitude"]').value;
      
      // Check if location was successfully fetched on load
      if (!lat || !lon) {
         // Try to get location again immediately before submitting
         if (navigator.geolocation) {
             navigator.geolocation.getCurrentPosition(function(position) {
                // Set the fields on success and submit
                form.querySelector('[name="latitude"]').value = position.coords.latitude;
                form.querySelector('[name="longitude"]').value = position.coords.longitude;
                form.submit();
             }, function(error) {
                alert("Location not detected. Please enable location services and reload.");
             });
         } else {
             alert("Geolocation is not supported by this browser.");
         }
         return false; // Prevent default form submission
      }

      // Location is already set, allow submission
      return true;
    }

  </script>
</head>
<body>

  <header style="padding: 20px; display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h2>Welcome {{ user.name }}</h2>
      <h2 style="font-size:14px; margin-top:2px;">Zugo Private Limited</h2>
    </div>
    <div style="display:flex; align-items:center; gap:12px;">
      <!-- Notifications (bell) -->
      <div id="notif" style="position:relative; display:inline-block; cursor:pointer;">
        <span id="notifBell">üîî</span>
        {% if error or success %}
        <span id="notifBadge" style="position:absolute; top:-6px; right:-6px; background:#e74c3c; color:white; border-radius:50%; padding:2px 6px; font-size:12px;">1</span>
        {% endif %}
        <div id="notifDropdown" style="display:none; position:absolute; right:0; top:26px; background:white; border:1px solid #ddd; box-shadow:0 2px 6px rgba(0,0,0,0.15); width:320px; z-index:200;">
          <div style="padding:10px; font-weight:bold; border-bottom:1px solid #eee;">Notifications</div>
          <div style="max-height:200px; overflow:auto;">
            {% if error %}
              <div style="padding:10px; border-bottom:1px solid #f5f5f5; color:#c0392b;">‚ö†Ô∏è {{ error | replace('+',' ') }}</div>
            {% endif %}
            {% if success %}
              <div style="padding:10px; border-bottom:1px solid #f5f5f5; color:#2ecc71;">‚úÖ {{ success | replace('+',' ') }}</div>
            {% endif %}
            {% if not (error or success) %}
              <div style="padding:10px; color:#666;">No notifications</div>
            {% endif %}
          </div>
        </div>
      </div>

      <a href="{{ url_for('workspace') }}" style="color: #FFFFFF; text-decoration: none; padding-right: 12px;">
        <span>üíº Workspace</span>
      </a>
      <a href="{{ url_for('logout') }}" style="color: #FFFFFF; text-decoration: none; padding-right: 12px;"><span>üö™ Logout</span></a>
    </div>
  </header>

  <div class="section-title">Employee</div>

  {% if error %}
    <p class="error-message">{{ error }}</p>
  {% endif %}
  {% if success_message %}
    <p class="success-message" style="color: green; font-weight: bold; margin-bottom: 15px; text-align: center; width: 100%;">{{ success_message }}</p>
  {% endif %}

  <div class="card">
    <!-- Left Side (Photo) -->
    <div class="photo-section">
      <strong>Photo</strong>
      <img src="{{ url_for('static', path=user.photo) }}" alt="Photo">
      <h2>{{ user.name }}</h2>
      <br>
      <br>
      <div class="detail"><strong>Total Working Days </strong> {{ user.total_working }}</div>
      <br>
      <br>
      <div class="detail"><strong>Total Leaves:</strong> {{ user.total_leave }}</div>
      
    </div>

    <!-- Right Side (Details) -->
    <div class="details-section">
      <h3>Employee Details</h3>
      <div class="details-grid">
        <div class="detail"><strong>Joining Date</strong>{{ user.joining_date }}</div>
        <div class="detail"><strong>Employee Number</strong>{{ user.employee_number }}</div>
        <div class="detail"><strong>Name</strong>{{ user.name }}</div>
        <div class="detail"><strong>Mobile Number</strong>{{ user.phone }}</div>
        <div class="detail"><strong>Parent Mobile Number</strong>{{ user.parent_phone }}</div>
        <div class="detail"><strong>Email</strong>{{ user.email }}</div>
        <div class="detail"><strong>Date of Birth</strong>{{ user.dob }}</div>
        <div class="detail"><strong>Gender</strong>{{ user.gender }}</div>
        <div class="detail"><strong>Job Role</strong>{{ user.job_role }}</div>
        <div class="detail"><strong>Native</strong>{{ user.native }}</div>
        <div class="detail"><strong>Present Address</strong>{{ user.address }}</div>
        <div class="detail"><strong>Aadhar Number</strong>{{ user.aadhar }}</div>
      </div>
    </div>
  </div>

  <div class="button-container">
    <form method="POST" action="/attendance" onsubmit="return setLocationAndSubmit(this)">
      <input type="hidden" name="action" value="check-in">
      <input type="hidden" id="latitude_checkin" name="latitude">
      <input type="hidden" id="longitude_checkin" name="longitude">
    </form>
    <form method="POST" action="/attendance" onsubmit="return setLocationAndSubmit(this)">

   
      <input type="hidden" id="latitude_checkout" name="latitude">
      <input type="hidden" id="longitude_checkout" name="longitude">    
    </form>
  </div>
</body>
</html>